<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NeoChat</title>
  <style>
    :root { --chat-w: 1300px; --chat-h: 810px; --stroke: #e6e9ef; --stroke-strong: #d8dee8; --radius: 18px; }
    /* Базовая раскладка: страница не скроллится, скроллятся только колонки */
    html, body { height: 100%; margin: 0; }
    body { height: 100vh; overflow: hidden; background: #f2f4f8; color: #151717; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }

    /* Экран поиска */
    .center { position: absolute; inset: 0; display: grid; place-items: center; }
    .center > div { transform: translateY(-60px); }
    @media (max-width: 640px) { .center > div { transform: translateY(-30px); } }
    .hero { display: grid; gap: 10px; justify-items: center; margin-bottom: 18px; text-align: center; }
    .hero h1 { margin: 0; font-size: clamp(26px, 4vw, 48px); letter-spacing: .4px; font-weight: 800; background: linear-gradient(90deg, #0f172a, #334155, #111827); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .hero p { margin: 0; color: #667085; font-size: 15px; }
    .search-wrap { width: min(800px, 92vw); height: 86px; position: relative; display: flex; align-items: center; justify-content: center; }
    .search-glow { position: absolute; width: 420px; height: 420px; border-radius: 50%; filter: blur(60px); background: radial-gradient(circle at 40% 50%, rgba(255,75,209,.28), transparent 55%), radial-gradient(circle at 60% 50%, rgba(107,182,255,.28), transparent 55%); opacity: .75; }
    .panel-bg { position: absolute; inset: 0; border-radius: var(--radius); background: #ffffff; box-shadow: 0 12px 30px rgba(16,24,40,.10); border: 1px solid var(--stroke); }
    .panel-inner { position: absolute; inset: 1px; border-radius: calc(var(--radius) - 1px); background: #ffffff; }
    .panel-stroke { position: absolute; inset: 0; border-radius: var(--radius); pointer-events: none; box-shadow: 0 0 0 1px var(--stroke) inset; }
    .search { position: relative; width: 100%; padding: 10px 12px; display: flex; align-items: center; gap: 10px; }
    .search input { flex: 1; height: 54px; background: #ffffff; color: #151717; border: 1px solid var(--stroke); outline: none; border-radius: 14px; padding-left: 48px; padding-right: 56px; transition: border-color .15s ease, box-shadow .15s ease; }
    .search input::placeholder { color: #98a2b3; }
    .search input:focus { border-color: var(--stroke-strong); box-shadow: 0 0 0 4px rgba(15,23,42,.06); }
    .search .icon-left { position: absolute; left: 22px; width: 22px; height: 22px; opacity: .9; }
    .search .submit { position: absolute; right: 18px; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; border-radius: 12px; border: 1px solid var(--stroke); background: linear-gradient(180deg, #111827, #0f172a); cursor: pointer; box-shadow: 0 8px 18px rgba(15,23,42,.18); display: grid; place-items: center; transition: transform .15s ease, box-shadow .2s ease, background .2s ease; }
    .search .submit:hover { transform: translateY(-50%) scale(1.05); box-shadow: 0 12px 26px rgba(15,23,42,.25); }
    .search .submit svg { pointer-events: none; }

    /* Подсказки (автодополнение) */
    .suggest { position: absolute; top: calc(100% + 10px); left: 0; right: 0; z-index: 10; }
    .suggest .box { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 12px 28px rgba(16,24,40,.12); overflow: hidden; }
    .suggest ul { list-style: none; margin: 0; padding: 6px; max-height: 260px; overflow-y: auto; }
    .suggest li { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 10px; cursor: pointer; color: #0f172a; }
    .suggest li svg { width: 18px; height: 18px; opacity: .8; }
    .suggest li:hover, .suggest li.active { background: #f8fafc; }

    /* Основной макет чата */
    .app { position: absolute; inset: 0; display: grid; }
    .layout { position: relative; display: grid; grid-template-columns: 260px 1fr; height: 100%; transition: grid-template-columns .25s ease; }
    .layout.collapsed { grid-template-columns: 60px 1fr; }
    /* Вертикальная разделительная линия (фиксированная) */
    .layout::before { content:""; position: fixed; top: 0; bottom: 0; left: 260px; width: 1px; background: #d7dde6; transition: left .25s ease; z-index: 3; pointer-events: none; }
    .layout.collapsed::before { left: 60px; }
    .chat-col { display: grid; grid-template-rows: auto 1fr; height: 100%; border-left: none; background: #ffffff; overflow: hidden; }
    .chat-header { padding: 14px 18px; background: #ffffff; border-bottom: 1px solid #d7dde6; font-weight: 600; color: #151717; }
    .messages-wrap { position: relative; display: grid; grid-template-rows: 1fr auto; height: min(var(--chat-h), calc(100vh - 160px)); width: min(var(--chat-w), 92vw); margin: 24px auto; border-radius: var(--radius); overflow: hidden; background: #ffffff; border: 1px solid #d7dde6; box-shadow: 0 12px 24px rgba(16,24,40,.06); }
    .messages { overflow-y: auto; padding: 18px 18px 160px; display: flex; flex-direction: column; gap: 10px; background: #ffffff; }
    .composer { position: sticky; bottom: 0; z-index: 2; display: flex; justify-content: center; padding: 14px 16px; background: #ffffff; border-top: 1px solid var(--stroke); }
    .composer .bar { width: min(520px, 92%); display: grid; grid-template-columns: 1fr auto; gap: 10px; background: #ffffff; border: 1px solid var(--stroke); border-radius: 24px; padding: 10px 12px; box-shadow: 0 8px 24px rgba(16,24,40,.08); }
    .composer input[type=text] { background: transparent; border: none; outline: none; color: #151717; font-size: 15px; padding: 8px; }
    .composer .send { width: 40px; height: 40px; border-radius: 12px; border: 1px solid #e5e7eb; background: linear-gradient(180deg, #111827, #0f172a); color: #e5e7eb; display: grid; place-items: center; cursor: pointer; }

    .msg { max-width: 70%; padding: 12px 14px; border-radius: 12px; box-shadow: none; border: 1px solid var(--stroke); }
    .msg.user { background: #f6f8ff; border-color: #dbeafe; color: #111827; margin-left: auto; text-align: left; border-top-right-radius: 6px; }
    .msg.ai { background: #f7fafc; border-color: #e7eef7; color: #111827; margin-right: auto; border-top-left-radius: 6px; }
    .msg small { display: block; opacity: .65; margin-bottom: 6px; font-size: 12px; }

    /* правую историю удалили */

    /* Левая панель (как у ChatGPT) */
    .sidebar { background: #ffffff; border-right: none; display: grid; grid-template-rows: auto 1fr auto; height: 100%; min-height: 0; width: 100%; }
    .sidebar { transition: padding .25s ease; }
    .side-top { position: sticky; top: 0; padding: 12px; border-bottom: 1px solid #d7dde6; background: #ffffff; z-index: 1; display: grid; grid-template-columns: 36px 1fr; grid-template-rows: auto auto; gap: 8px 10px; align-items: start; }
    .side-top .collapse-btn { width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--stroke); background: linear-gradient(180deg, #111827, #0f172a); color: #e5e7eb; display: grid; place-items: center; cursor: pointer; }
    .side-top button { width: 100%; height: 40px; border-radius: 10px; border: 1px solid var(--stroke); background: #151717; color: #fff; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    /* разместим кнопки столбиком: свернуть (row1 col1), новый чат (row2 col1) */
    #collapseBtn { grid-column: 1; grid-row: 1; }
    #newChatBtnSidebar { grid-column: 1 / -1; grid-row: 2; white-space: nowrap; }
    /* Переключатель темы справа от кнопки свернуть */
    #themeToggleBtn { grid-column: 2; grid-row: 1; justify-self: end; width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--stroke); background: linear-gradient(180deg, #111827, #0f172a); color: #e5e7eb; display: grid; place-items: center; cursor: pointer; }
    #themeToggleBtn:hover { filter: brightness(1.05); }
    #themeToggleBtn svg { stroke: currentColor; }
    #themeToggleBtn:hover { background: #f3f4f6; }
    .side-top button svg { min-width: 16px; min-height: 16px; }
    .side-list { overflow-y: auto; min-height: 0; padding-top: 6px; }
    /* Ряд истории с кнопкой настроек */
    .side-row { position: relative; display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid var(--stroke); }
    .side-row .title { color: #111827; text-decoration: none; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; flex: 1; }
    .side-row:hover { background: #f9fafb; }
    .opt-btn { width: 28px; height: 28px; border-radius: 8px; border: 1px solid var(--stroke); background: #ffffff; display: grid; place-items: center; cursor: pointer; margin-left: 8px; }
    .opt-btn:hover { background: #f3f4f6; }
    .side-menu { position: absolute; right: 12px; top: calc(100% + 6px); background: #ffffff; border: 1px solid var(--stroke); border-radius: 10px; box-shadow: 0 12px 28px rgba(16,24,40,.12); display: none; z-index: 20; }
    .side-menu.show { display: block; }
    .side-menu button { display: block; width: 160px; background: transparent; border: none; text-align: left; padding: 10px 12px; cursor: pointer; }
    .side-menu button:hover { background: #f3f4f6; }
    /* Состояние при свёрнутой панели: показываем только кнопку-стрелку и компактный новый чат */
    .layout.collapsed .side-row { display: none; }
    .layout.collapsed #themeToggleBtn { grid-column: 1; grid-row: 2; justify-self: start; }
    .layout.collapsed #newChatBtnSidebar { grid-column: 1; grid-row: 3; width: 36px; padding: 0; height: 36px; }
    .layout.collapsed #newChatBtnSidebar .label { display: none; }
    .side-bottom { padding: 10px 12px; border-top: 1px solid #d7dde6; color: #667085; font-size: 13px; margin-bottom: 28px; position: relative; overflow: visible; }
    .auth-actions { display: grid; gap: 8px; }
    .auth-actions .btn { height: 36px; border-radius: 10px; border: 1px solid var(--stroke); background: #ffffff; color: #111827; cursor: pointer; }
    .auth-actions .btn.primary { background: #111827; color: #ffffff; border-color: #111827; }
    .profile-mini { display: flex; align-items: center; gap: 10px; }
    .profile-mini .avatar { width: 28px; height: 28px; border-radius: 50%; border: 1px solid var(--stroke); background: #f1f5f9; }
    .profile-mini .name { color: #0f172a; font-weight: 600; }

    /* Popup auth menu (scoped to sidebar bottom) */
    .side-bottom .popup {
      --burger-line-width: 1.125em;
      --burger-line-height: 0.125em;
      --burger-offset: 0.625em;
      --burger-bg: linear-gradient(180deg, #111827, #0f172a);
      --burger-color: #333;
      --burger-line-border-radius: 0.1875em;
      --burger-diameter: 40px;
      --burger-btn-border-radius: calc(var(--burger-diameter) / 2);
      --burger-line-transition: 0.3s;
      --burger-transition: all 0.1s ease-in-out;
      --burger-hover-scale: 1.1;
      --burger-active-scale: 0.95;
      --burger-enable-outline-color: var(--burger-bg);
      --burger-enable-outline-width: 0.125em;
      --burger-enable-outline-offset: var(--burger-enable-outline-width);
      --nav-padding-x: 0.25em;
      --nav-padding-y: 0.625em;
      --nav-border-radius: 0.375em;
      --nav-border-color: #ccc;
      --nav-border-width: 0.0625em;
      --nav-shadow-color: rgba(0, 0, 0, 0.2);
      --nav-shadow-width: 0 1px 5px;
      --nav-bg: #ffffff;
      --nav-font-family: "Poppins", sans-serif;
      --nav-default-scale: 0.8;
      --nav-active-scale: 1;
      --nav-position-left: unset;
      --nav-position-right: 0;
      --nav-title-size: 0.625em;
      --nav-title-color: #667085;
      --nav-title-padding-x: 1rem;
      --nav-title-padding-y: 0.25em;
      --nav-button-padding-x: 1rem;
      --nav-button-padding-y: 0.375em;
      --nav-button-border-radius: 0.375em;
      --nav-button-font-size: 17px;
      --nav-button-hover-bg: #111827;
      --nav-button-hover-text-color: #ffffff;
      --nav-button-distance: 0.875em;
      --underline-border-width: 0.0625em;
      --underline-border-color: #ccc;
      --underline-margin-y: 0.3125em;
      display: inline-block;
      text-rendering: optimizeLegibility;
      position: relative;
    }
    .side-bottom .popup input { display: none; }
    .side-bottom .burger {
      display: flex; position: relative; align-items: center; justify-content: center;
      background: var(--burger-bg); width: var(--burger-diameter); height: var(--burger-diameter);
      border-radius: 12px; border: 1px solid var(--stroke); cursor: pointer; overflow: hidden;
      box-shadow: 0 8px 18px rgba(15,23,42,.18);
      transition: var(--burger-transition); outline: var(--burger-enable-outline-width) solid transparent; outline-offset: 0;
    }
    .side-bottom .popup-window {
      transform: translateY(calc(-50% - 12px)) scale(var(--nav-default-scale)); visibility: hidden; opacity: 0; position: absolute; z-index: 1000;
      padding: 10px 8px; background: var(--nav-bg);
      font-family: var(--nav-font-family); color: #0f172a; border-radius: 12px;
      box-shadow: 0 16px 30px rgba(16,24,40,.12); border: 1px solid var(--stroke);
      top: 50%; left: calc(100% + 10px); right: auto; transition: var(--burger-transition);
    }
    .side-bottom .popup-window legend { padding: 6px 12px; margin: 0; color: var(--nav-title-color); font-size: 11px; letter-spacing: .4px; text-transform: uppercase; }
    .side-bottom .popup-window ul { margin: 0; padding: 0; list-style-type: none; }
    .side-bottom .popup-window ul button {
      outline: none; width: 100%; border: none; background: none; display: flex; align-items: center; color: #0f172a;
      font-size: 15px; padding: 10px 12px; white-space: nowrap; border-radius: 10px; cursor: pointer; column-gap: 10px;
    }
    .side-bottom .popup-window ul li:nth-child(1) svg,
    .side-bottom .popup-window ul li:nth-child(2) svg { color: #000000; }
    .side-bottom .popup-window ul li:nth-child(4) svg,
    .side-bottom .popup-window ul li:nth-child(5) svg { color: rgb(153, 153, 153); }
    .side-bottom .popup-window ul li:nth-child(7) svg { color: red; }
    .side-bottom .popup-window hr { margin: var(--underline-margin-y) 0; border: none; border-bottom: var(--underline-border-width) solid var(--underline-border-color); }
    .side-bottom .popup-window ul button:hover,
    .side-bottom .popup-window ul button:focus-visible,
    .side-bottom .popup-window ul button:hover svg,
    .side-bottom .popup-window ul button:focus-visible svg { color: var(--nav-button-hover-text-color); background: var(--nav-button-hover-bg); }
    .side-bottom .burger:hover { transform: scale(var(--burger-hover-scale)); }
    .side-bottom .burger:active { transform: scale(var(--burger-active-scale)); }
    .side-bottom .burger:focus:not(:hover) { outline-color: var(--burger-enable-outline-color); outline-offset: var(--burger-enable-outline-offset); }
    .side-bottom .popup input:checked ~ nav { transform: translateY(calc(-50% - 12px)) scale(var(--nav-active-scale)); visibility: visible; opacity: 1; }

    /* Floating sidebar toggle button */
    .side-toggle { width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--stroke); background: linear-gradient(180deg, #111827, #0f172a); color: #e5e7eb; display: grid; place-items: center; cursor: pointer; box-shadow: 0 8px 18px rgba(15,23,42,.18); transition: transform .15s ease, box-shadow .2s ease; }
    .side-toggle:hover { transform: translateY(-1px); box-shadow: 0 12px 22px rgba(15,23,42,.24); }

    .float-stack { position: fixed; left: 18px; top: 18px; display: flex; flex-direction: column; gap: 10px; z-index: 1100; transition: left .25s ease; }
    .float-newchat { width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--stroke); background: #ffffff; color: #0f172a; display: grid; place-items: center; cursor: pointer; box-shadow: 0 8px 18px rgba(15,23,42,.14); }

    /* Mini dock removed */

    /* Settings modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(15,23,42,.35); display: none; align-items: center; justify-content: center; z-index: 1200; }
    .modal-backdrop.show { display: flex; }
    .modal { width: min(520px, 92vw); background: #ffffff; border: 1px solid var(--stroke); border-radius: 14px; box-shadow: 0 16px 40px rgba(16,24,40,.22); }
    .modal header { padding: 14px 16px; border-bottom: 1px solid var(--stroke); display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #0f172a; }
    .modal .content { padding: 14px 16px; display: grid; gap: 12px; }
    /* Settings tabs */
    .tabs { display: flex; gap: 8px; border-bottom: 1px solid var(--stroke); padding-bottom: 8px; }
    .tab-btn { padding: 8px 10px; border: 1px solid var(--stroke); background:#fff; border-radius:8px; cursor:pointer; }
    .tab-btn.active { background:#111827; color:#fff; border-color:#111827; }
    .tab-panel { display:none; }
    .tab-panel.active { display:block; }
    /* Pretty slider */
    .range { -webkit-appearance: none; width: 240px; height: 6px; border-radius: 999px; background: linear-gradient(90deg,#5c94f0,#a78bfa); outline:none; }
    .range::-webkit-slider-thumb { -webkit-appearance: none; width:18px;height:18px;border-radius:50%;background:#fff;border:2px solid #5c94f0; box-shadow:0 2px 8px rgba(0,0,0,.15); cursor:pointer; }
    .kv { font-size:13px; color:#667085; }
    .modal .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .modal .close { background: transparent; border: 1px solid var(--stroke); border-radius: 10px; width: 32px; height: 32px; display: grid; place-items: center; cursor: pointer; }

    /* Rename dialog */
    .modal .field { display: grid; gap: 8px; }
    .modal input[type=text] { width: 100%; max-width: 100%; height: 40px; box-sizing: border-box; border-radius: 10px; border: 1px solid var(--stroke); padding: 0 10px; outline: none; }
    .modal .actions { display: flex; gap: 10px; justify-content: flex-end; }
    .btn { height: 36px; padding: 0 14px; border-radius: 10px; border: 1px solid var(--stroke); background: #ffffff; cursor: pointer; }
    .btn.primary { background: #151717; color: #fff; border-color: #151717; }

    /* Тёмная тема (как на скриншоте) */
    /* Тёмная тема #202123 (закрашиваем всё, без белого) */
    :root[data-theme="dark"], :root[data-theme="dark"] body, :root[data-theme="dark"] html { background: #202123; color: #e5e7eb; }
    :root[data-theme="dark"] .app { background: #202123; }
    :root[data-theme="dark"] .layout::before { background: #2a2f3a; }
    :root[data-theme="dark"] .sidebar { background: #202123; }
    :root[data-theme="dark"] .side-top { background: #202123; border-bottom-color: #2a2f3a; }
    :root[data-theme="dark"] .side-list { background: #202123; }
    :root[data-theme="dark"] .side-bottom { background: #202123; border-top-color: #2a2f3a; }
    :root[data-theme="dark"] .chat-header { background: #202123; color: #e5e7eb; border-bottom-color: #2a2f3a; }
    :root[data-theme="dark"] .messages-wrap { background: #202123; border-color: #2a2f3a; box-shadow: 0 12px 24px rgba(0,0,0,.30); }
    :root[data-theme="dark"] .messages { background: #202123; }
    :root[data-theme="dark"] .composer { background: #202123; border-top-color: #2a2f3a; }
    :root[data-theme="dark"] .composer .bar { background: #2a2f3a; border-color: #2a2f3a; box-shadow: 0 8px 24px rgba(0,0,0,.35); }
    :root[data-theme="dark"] .send { background: #ffffff; border-color: #ffffff; }
    :root[data-theme="dark"] .send svg path { stroke: #0f172a !important; }
    :root[data-theme="dark"] .composer input[type=text] { color: #e5e7eb; }
    :root[data-theme="dark"] .composer input[type=text]::placeholder { color: #b6bbc6; }
    :root[data-theme="dark"] .side-row:hover { background: #2a2f3a; }
    :root[data-theme="dark"] .opt-btn { background: #202123; border-color: #2a2f3a; }
    :root[data-theme="dark"] .side-menu { background: #2a2f3a; border-color: #3a3f4a; }
    :root[data-theme="dark"] .modal { background: #202123; border-color: #2a2f3a; }
    :root[data-theme="dark"] .modal header { border-bottom-color: #2a2f3a; color: #e5e7eb; }
    :root[data-theme="dark"] .modal input[type=text] { background: #2a2f3a; color: #e5e7eb; border-color: #3a3f4a; }
    :root[data-theme="dark"] .modal input[type=text]::placeholder { color: #b6bbc6; }
    :root[data-theme="dark"] .btn { background: #2a2f3a; color: #e5e7eb; border-color: #3a3f4a; }
    :root[data-theme="dark"] .btn.primary { background: #111827; border-color: #374151; color: #e5e7eb; }
    :root[data-theme="dark"] .msg.user { background: #2f3138; border-color: #3b404c; color: #e5e7eb; }
    :root[data-theme="dark"] .msg.ai { background: #26282e; border-color: #3a3f4a; color: #e5e7eb; }

    /* Welcome */
    .welcome { height: 100%; display: grid; place-items: center; color: #151717; }
    .welcome h1 { font-size: 28px; margin: 0 0 10px; }
    .welcome p { color: #000000; margin: 0 0 20px; }
    /* Pattern for chat background (light dark theme) */
    .chat-pattern {
      --s: 60px;
      --tree-color: #000000; /* darker green */
      --ornament-color: #ff4d4d; /* softer red */
      --snowflake-color: rgba(255,255,255,.85);
      --background-color: #1b1d23; /* light-dark */

      --_c: var(--tree-color), var(--background-color) 1deg 79deg,
      var(--background-color) 81deg;

      --g0: conic-gradient(from 140deg at 50% 87.5%, var(--_c));
      --g1: conic-gradient(from 140deg at 50% 81.25%, var(--_c));
      --g2: conic-gradient(from 140deg at 50% 75%, var(--_c));

      --g3: conic-gradient(at 10% 20%, #0000 75%, var(--snowflake-color) 0);
      --g4: repeating-conic-gradient(from 45deg, var(--ornament-color) 0 25%, #fff 0 50%);

      background:
        var(--g0) 0 calc(var(--s) / -4),
        var(--g0) var(--s) calc(3 * var(--s) / 4),
        var(--g1),
        var(--g1) var(--s) var(--s),
        var(--g2) 0 calc(var(--s) / 4),
        var(--g2) var(--s) calc(5 * var(--s) / 4),
        var(--g3) calc(var(--s) / -10) var(--s),
        var(--g3) calc(9 * var(--s) / 10) calc(2 * var(--s)),
        var(--g4) calc(var(--s) / 2) var(--s);

      background-size: calc(2 * var(--s)) calc(2 * var(--s));
      background-position: center center;
      background-repeat: repeat;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body { overflow: auto; }
      .layout { grid-template-columns: 60px 1fr; }
      .layout::before { left: 60px; }
      .messages-wrap {
        width: calc(100vw - 24px);
        height: calc(100vh - 180px);
        margin: 12px auto;
      }
      .composer { padding: 10px 12px; }
      .composer .bar { width: 100%; }
      .search-wrap { width: 92vw; height: 78px; }
    }

    /* Compact phones */
    @media (max-width: 480px) {
      .chat-header { padding: 12px 14px; font-size: 16px; }
      .messages { padding: 12px 12px 140px; }
      .msg { max-width: 86%; font-size: 14px; }
      .side-top { grid-template-columns: 36px; grid-template-rows: repeat(3, 40px); gap: 8px; }
      #themeToggleBtn { display: none; }
      #newChatBtnSidebar { grid-column: 1; grid-row: 2; }
      .layout.collapsed #newChatBtnSidebar { width: 36px; }
      .side-bottom { padding: 8px; }
      .side-bottom .popup-window { left: calc(100% + 6px); transform: translateY(calc(-50% - 8px)) scale(.96); }
      .messages-wrap { height: calc(100vh - 150px); }
      .composer { padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
      .composer .bar { gap: 8px; }
      .composer input[type=text] { font-size: 14px; }
      .composer .send { width: 36px; height: 36px; }
    }
  </style>
</head>
<body class="container">
  <!-- Экран поиска -->
  <div class="center" id="screen-search">
    <div>
      <div class="hero">
        <h1>Добро пожаловать</h1>
        <p>Введите запрос, чтобы начать</p>
      </div>
    <div class="search-wrap">
      <div class="search-glow"></div>
      <div class="panel-bg"></div>
      <div class="panel-inner"></div>
      <div class="panel-stroke"></div>
      <form class="search" id="searchForm">
        <input type="text" id="searchQuery" placeholder="Введите запрос..." required />
        <svg class="icon-left" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" fill="none">
          <circle stroke="#b6a9b7" r="8" cy="11" cx="11"></circle>
          <line stroke="#837484" y2="16.65" y1="22" x2="16.65" x1="22"></line>
        </svg>
        <button class="submit" type="submit" title="Отправить" aria-label="Отправить">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M22 2L11 13" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
          <div class="suggest" id="suggestionWrap" style="display:none">
            <div class="box">
              <ul id="suggestionList"></ul>
            </div>
          </div>
      </form>
      </div>
    </div>
  </div>

  <!-- Экран чата -->
  <div class="app" id="screen-chat" style="display:none">
    
    <div class="layout">
      <aside class="sidebar">
        <div class="side-top">
          <button class="collapse-btn" id="collapseBtn" title="Свернуть/развернуть">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="4"/><line x1="12" y1="7" x2="12" y2="17"/><line x1="9" y1="7" x2="9" y2="17"/></svg>
          </button>
          <button id="themeToggleBtn" title="Светлая/тёмная тема">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          </button>
          <button type="button" id="newChatBtnSidebar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            <span class="label">Новый чат</span>
          </button>
        </div>
        <div class="side-list" id="sideList"></div>
        <div class="side-bottom">
          <label class="popup">
            <input type="checkbox" />
            <div tabindex="0" class="burger">
              <svg viewBox="0 0 24 24" fill="white" height="20" width="20" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2c2.757 0 5 2.243 5 5.001 0 2.756-2.243 5-5 5s-5-2.244-5-5c0-2.758 2.243-5.001 5-5.001zm0-2c-3.866 0-7 3.134-7 7.001 0 3.865 3.134 7 7 7s7-3.135 7-7c0-3.867-3.134-7.001-7-7.001zm6.369 13.353c-.497.498-1.057.931-1.658 1.302 2.872 1.874 4.378 5.083 4.972 7.346h-19.387c.572-2.29 2.058-5.503 4.973-7.358-.603-.374-1.162-.811-1.658-1.312-4.258 3.072-5.611 8.506-5.611 10.669h24c0-2.142-1.44-7.557-5.631-10.647z"></path>
              </svg>
            </div>
            <nav class="popup-window" id="profileMenu">
              <legend>Быстрый доступ</legend>
              <ul>
                <li class="menu-item auth-only">
                  <button id="popupLoginBtn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" xmlns="http://www.w3.org/2000/svg"><path d="M19 4v6.406l-3.753 3.741-6.463-6.462 3.7-3.685h6.516zm2-2h-12.388l1.497 1.5-4.171 4.167 9.291 9.291 4.161-4.193 1.61 1.623v-12.388zm-5 4c.552 0 1 .449 1 1s-.448 1-1 1-1-.449-1-1 .448-1 1-1zm0-1c-1.104 0-2 .896-2 2s.896 2 2 2 2-.896 2-2-.896-2-2-2zm6.708.292l-.708.708v3.097l2-2.065-1.292-1.74zm-12.675 9.294l-1.414 1.414h-2.619v2h-2v2h-2v-2.17l5.636-5.626-1.417-1.407-6.219 6.203v5h6v-2h2v-2h2l1.729-1.729-1.696-1.685z"></path></svg>
                    <span>Войти</span>
                  </button>
                </li>
                <li class="menu-item auth-only">
                  <button id="popupSignupBtn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" xmlns="http://www.w3.org/2000/svg"><path d="M2.598 9h-1.055c1.482-4.638 5.83-8 10.957-8 6.347 0 11.5 5.153 11.5 11.5s-5.153 11.5-11.5 11.5c-5.127 0-9.475-3.362-10.957-8h1.055c1.443 4.076 5.334 7 9.902 7 5.795 0 10.5-4.705 10.5-10.5s-4.705-10.5-10.5-10.5c-4.568 0-8.459 2.923-9.902 7zm12.228 3l-4.604-3.747.666-.753 6.112 5-6.101 5-.679-.737 4.608-3.763h-14.828v-1h14.826z"></path></svg>
                    <span>Зарегистрироваться</span>
                  </button>
                </li>
                <li class="menu-item authed-only" style="display:none">
                  <button id="popupSettingsBtn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" xmlns="http://www.w3.org/2000/svg"><path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7Zm7.4-3.5a5.6 5.6 0 0 0 .05-.75 5.6 5.6 0 0 0-.05-.75l2.05-1.6a.5.5 0 0 0 .12-.65l-1.94-3.36a.5.5 0 0 0-.6-.22l-2.41.97a6.15 6.15 0 0 0-1.3-.76l-.36-2.56A.5.5 0 0 0 12.5 1h-3a.5.5 0 0 0-.5.42l-.36 2.56c-.45.18-.9.41-1.3.76l-2.41-.97a.5.5 0 0 0-.6.22L1.89 7.35a.5.5 0 0 0 .12.65l2.05 1.6a5.6 5.6 0 0 0 0 1.5l-2.05 1.6a.5.5 0 0 0-.12.65l1.94 3.36a.5.5 0 0 0 .6.22l2.41-.97c.4.35.85.58 1.3.76l.36 2.56a.5.5 0 0 0 .5.42h3a.5.5 0 0 0 .5-.42l.36-2.56c.45-.18.9-.41 1.3-.76l2.41.97a.5.5 0 0 0 .6-.22l1.94-3.36a.5.5 0 0 0-.12-.65L19.4 12Z"/></svg>
                    <span>Настройки</span>
                  </button>
                </li>
                <li class="menu-item authed-only" style="display:none">
                  <button id="popupLogoutBtn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" xmlns="http://www.w3.org/2000/svg"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path d="M16 17l5-5-5-5"/><path d="M21 12H9"/></svg>
                    <span>Выйти</span>
                  </button>
                </li>
              </ul>
            </nav>
          </label>
        </div>
      </aside>
      <section class="chat-col">
        <header class="chat-header" id="chatTitle">Новый диалог</header>
        <div class="welcome" id="welcome">
          <div>
            <h1>Над чем ты работаешь?</h1>
            <p>Сформулируй запрос или начни новый чат</p>
          </div>
        </div>
        <div class="messages-wrap" id="messagesWrap" style="display:none">
          <div class="messages" id="messages"></div>
          <form class="composer" id="composerForm">
            <div class="bar">
              <input id="composerInput" type="text" placeholder="Спросите что-нибудь..." required />
              <button class="send" type="submit" title="Отправить" aria-label="Отправить">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M22 2L11 13" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </form>
        </div>
      </section>
    </div>
    <!-- Mini dock shown when sidebar collapsed -->
    
    <!-- Settings Modal -->
    <div class="modal-backdrop" id="settingsModal">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <header>
          <div id="settingsTitle">Настройки</div>
          <button class="close" id="settingsClose" aria-label="Закрыть">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </header>
        <div class="content">
          <div class="tabs">
            <button class="tab-btn active" data-tab="general">Общие</button>
            <button class="tab-btn" data-tab="account">Аккаунт</button>
            <button class="tab-btn" data-tab="security">Безопасность</button>
          </div>

          <div class="tab-panel active" id="tab-general">
            <div class="row" style="justify-content: space-between; align-items:center;">
              <span>Ширина чата</span>
              <div>
                <input class="range" type="range" id="chatWidth" min="600" max="1400" step="20" />
                <div class="kv">Текущее: <span id="chatWidthVal"></span> px</div>
              </div>
            </div>
          </div>

          <div class="tab-panel" id="tab-account">
            <div class="row" style="display:block;">
              <div class="kv">Статус: <span id="authProvider">Гость</span></div>
              <div style="display:flex; gap:8px; margin-top:8px;">
                <button class="btn" id="linkGoogle">Привязать Google</button>
                <button class="btn" id="linkGithub">Привязать GitHub</button>
                <button class="btn" id="unlinkAll">Отвязать все</button>
              </div>
            </div>
          </div>

          <div class="tab-panel" id="tab-security">
            <div class="row" style="display:block;">
              <div class="kv">Двухфакторная аутентификация (TOTP)</div>
              <div style="display:flex; gap:8px; margin:8px 0;">
                <button class="btn" id="enable2fa">Включить 2FA</button>
                <button class="btn" id="disable2fa">Выключить 2FA</button>
              </div>
              <div id="totpSetup" style="display:none;">
                <div class="kv">Секрет: <code id="totpSecret"></code></div>
                <div class="kv">Добавьте секрет в приложение-аутентификатор (Google Authenticator, 1Password и т.д.), затем введите одноразовый код ниже:</div>
                <div class="row">
                  <input type="text" id="totpCode" placeholder="123456" style="width:120px;" />
                  <button class="btn primary" id="verifyTotp">Подтвердить</button>
                </div>
                <div class="kv" id="totpMsg"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
      ? 'http://localhost:8090/api/v1'
      : 'http://localhost:8090/api/v1';
    const screenSearch = document.getElementById('screen-search');
    const screenChat = document.getElementById('screen-chat');
    const searchForm = document.getElementById('searchForm');
    const searchQuery = document.getElementById('searchQuery');
    const chatTitle = document.getElementById('chatTitle');
    const messagesEl = document.getElementById('messages');
    const composerForm = document.getElementById('composerForm');
    const composerInput = document.getElementById('composerInput');
    const historyEl = document.getElementById('sideList');

    const chats = []; // [{id, title, msgs:[{role,text}]}]
    const suggestions = [
      'Напиши план тренировок на неделю',
      'Придумай идеи для сайта портфолио',
      'Сделай резюме из этого текста',
      'Объясни тему простыми словами',
      'Сгенерируй SQL-запрос по описанию',
      'Подскажи, как оптимизировать код',
      'Сформируй письмо клиенту',
      'Что нового в JavaScript 2025?'
    ];
    const suggestionWrap = document.getElementById('suggestionWrap');
    const suggestionList = document.getElementById('suggestionList');
    let activeSuggestIndex = -1;
    let activeChatId = null;

    function createChat(title) {
      const id = Date.now().toString();
      const chat = { id, title, msgs: [] };
      chats.unshift(chat); // добавляем в начало списка (сверху)
      activeChatId = id;
      console.log('Created chat:', id, title);
      renderHistory();
      return chat;
    }

    function renderHistory() {
      historyEl.innerHTML = '';
      chats.forEach(c => {
        const row = document.createElement('div');
        row.className = 'side-row';
        const title = document.createElement('a');
        title.href = '#';
        title.className = 'title';
        title.textContent = c.title;
        title.onclick = (e)=>{ e.preventDefault(); openChat(c.id); };
        const opt = document.createElement('button');
        opt.className = 'opt-btn';
        opt.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>';
        const menu = document.createElement('div');
        menu.className = 'side-menu';
        const renameBtn = document.createElement('button');
        renameBtn.textContent = 'Переименовать';
        renameBtn.onclick = () => openRenameDialog(c);
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Удалить';
        delBtn.onclick = () => {
          const idx = chats.findIndex(x=>x.id===c.id);
          if (idx !== -1) { chats.splice(idx,1); if (activeChatId===c.id) { const first = chats[0]; if (first) openChat(first.id); else { messagesEl.innerHTML=''; chatTitle.textContent='Новый диалог'; } } renderHistory(); }
        };
        menu.appendChild(renameBtn); menu.appendChild(delBtn);
        opt.onclick = (e)=>{ e.stopPropagation(); menu.classList.toggle('show'); };
        row.appendChild(title); row.appendChild(opt); row.appendChild(menu);
        historyEl.appendChild(row);
      });
      historyEl.scrollTop = 0;
      document.addEventListener('click', function closeMenus(){
        historyEl.querySelectorAll('.side-menu.show').forEach(el=>el.classList.remove('show'));
      }, { once: true });
    }

    // Красивое переименование в модальном окне
    function openRenameDialog(chat){
      const modal = document.getElementById('settingsModal');
      const content = modal.querySelector('.content');
      modal.classList.add('show');
      content.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.className = 'field';
      const header = settingsModal.querySelector('header #settingsTitle');
      if (header) header.textContent = 'Переименовать чат';
      const label = document.createElement('label'); label.textContent = 'Новое имя чата';
      const input = document.createElement('input'); input.type='text'; input.value = chat.title;
      const actions = document.createElement('div'); actions.className = 'actions';
      const ok = document.createElement('button'); ok.className='btn primary'; ok.textContent='OK';
      const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Отмена';
      actions.appendChild(cancel); actions.appendChild(ok);
      wrap.appendChild(label); wrap.appendChild(input); content.appendChild(wrap); content.appendChild(actions);
      input.select();
      ok.onclick = () => { const nv = input.value.trim(); if (nv) { chat.title = nv; renderHistory(); } modal.classList.remove('show'); };
      cancel.onclick = () => { modal.classList.remove('show'); };
    }

    function openChat(id) {
      console.log('Opening chat:', id);
      const chat = chats.find(c => c.id === id);
      if (!chat) {
        console.log('Chat not found:', id);
        return;
      }
      activeChatId = id;
      chatTitle.textContent = chat.title;
      messagesEl.innerHTML = '';
      chat.msgs.forEach(m => addMsgEl(m.role, m.text));
      console.log('Chat opened successfully:', chat.title);
    }

    function addMsgEl(role, text) {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (role === 'user' ? 'user' : 'ai');
      const author = document.createElement('small');
      author.textContent = role === 'user' ? 'Вы' : 'NeoChat';
      const p = document.createElement('div');
      if (role !== 'user') {
        // простая анимация набора текста для ответа ИИ
        let i = 0;
        (function type(){
          p.textContent = text.slice(0, i++);
          if (i <= text.length) requestAnimationFrame(type);
        })();
      } else {
      p.textContent = text;
      }
      wrap.appendChild(author);
      wrap.appendChild(p);
      messagesEl.appendChild(wrap);
      requestAnimationFrame(()=>{ messagesEl.scrollTop = messagesEl.scrollHeight; });
    }

    async function sendToAI(text, chat) {
      try {
        console.log('Sending to Neural Network:', text);
        
        // Формируем контекст из истории чата
        let context = text;
        if (chat.msgs.length > 0) {
          const recentMessages = chat.msgs.slice(-4); // Берем последние 4 сообщения для контекста
          context = recentMessages.map(m => 
            m.role === 'user' ? `Пользователь: ${m.text}` : `Ассистент: ${m.text}`
          ).join('\n') + `\nПользователь: ${text}`;
        }
        
        const resp = await fetch(API_BASE + '/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: context,
            max_tokens: 200,
            temperature: 0.7,
            top_k: 50,
            top_p: 0.9,
            repetition_penalty: 1.1
          })
        });
        
        console.log('Response status:', resp.status);
        const data = await resp.json();
        console.log('Response data:', data);
        
        const reply = (data && data.text) || 'Извините, произошла ошибка.';
        console.log('Final reply:', reply);
        
        chat.msgs.push({ role: 'ai', text: reply });
        addMsgEl('ai', reply);
      } catch (e) {
        console.error('Error in sendToAI:', e);
        const err = 'Ошибка запроса к нейросети: ' + e.message;
        chat.msgs.push({ role: 'ai', text: err });
        addMsgEl('ai', err);
      }
    }

    searchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const q = searchQuery.value.trim();
      if (!q) return;
      hideSuggestions();
      
      // Если уже есть активный чат, добавляем сообщение в него
      if (activeChatId && chats.find(c => c.id === activeChatId)) {
        const chat = chats.find(c => c.id === activeChatId);
        chat.msgs.push({ role: 'user', text: q });
        addMsgEl('user', q);
        sendToAI(q, chat);
        searchQuery.value = '';
        return;
      }
      
      // Создаем новый чат только если нет активного
      const title = q.length > 40 ? q.slice(0, 40) + '…' : q;
      const chat = createChat(title);
      chat.msgs.push({ role: 'user', text: q });
      
      // Переключаемся на экран чата
      screenSearch.style.display = 'none';
      screenChat.style.display = 'block';
      document.getElementById('welcome').style.display = 'none';
      document.getElementById('messagesWrap').style.display = 'grid';
      
      addMsgEl('user', q);
      sendToAI(q, chat);
      searchQuery.value = '';
      composerInput.focus();
    });

    function renderSuggestions(items) {
      suggestionList.innerHTML = '';
      items.forEach((text, i) => {
        const li = document.createElement('li');
        li.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>' +
          '<span>' + text + '</span>';
        li.onmousedown = (e)=>{ e.preventDefault(); chooseSuggestion(text); };
        suggestionList.appendChild(li);
      });
      activeSuggestIndex = -1;
      suggestionWrap.style.display = items.length ? 'block' : 'none';
    }

    function chooseSuggestion(text) {
      searchQuery.value = text;
      hideSuggestions();
      searchForm.requestSubmit();
    }

    function hideSuggestions() {
      suggestionWrap.style.display = 'none';
    }

    searchQuery.addEventListener('input', () => {
      const q = searchQuery.value.trim().toLowerCase();
      if (!q) { hideSuggestions(); return; }
      const filtered = suggestions.filter(s => s.toLowerCase().includes(q)).slice(0, 8);
      renderSuggestions(filtered);
    });

    searchQuery.addEventListener('keydown', (e) => {
      const items = suggestionList.querySelectorAll('li');
      if (!items.length) return;
      if (e.key === 'ArrowDown') { e.preventDefault(); activeSuggestIndex = (activeSuggestIndex + 1) % items.length; }
      else if (e.key === 'ArrowUp') { e.preventDefault(); activeSuggestIndex = (activeSuggestIndex - 1 + items.length) % items.length; }
      else if (e.key === 'Enter') {
        if (activeSuggestIndex >= 0) { e.preventDefault(); chooseSuggestion(items[activeSuggestIndex].querySelector('span').textContent); }
        return;
      } else if (e.key === 'Escape') { hideSuggestions(); return; }
      items.forEach((li, i)=> li.classList.toggle('active', i === activeSuggestIndex));
    });

    searchQuery.addEventListener('blur', () => { setTimeout(hideSuggestions, 120); });

    composerForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const t = composerInput.value.trim();
      if (!t) return;
      const chat = chats.find(c => c.id === activeChatId);
      if (!chat) return;
      chat.msgs.push({ role: 'user', text: t });
      addMsgEl('user', t);
      composerInput.value = '';
      sendToAI(t, chat);
    });

    const floatNewChat = document.getElementById('floatNewChat');
    const newChatBtnSidebar = document.getElementById('newChatBtnSidebar');
    function handleNewChat(){ const chat = createChat('Новый диалог'); openChat(chat.id); historyEl.scrollTop = 0; }
    if (floatNewChat) floatNewChat.addEventListener('click', handleNewChat);
    if (newChatBtnSidebar) newChatBtnSidebar.addEventListener('click', handleNewChat);

    // popup не требует дополнительного JS; логика логина будет подключена позже
    const popupLoginBtn = document.getElementById('popupLoginBtn');
    const popupSignupBtn = document.getElementById('popupSignupBtn');
    if (popupLoginBtn) popupLoginBtn.addEventListener('click', function(){ window.location.href = 'registr.html?mode=login'; });
    if (popupSignupBtn) popupSignupBtn.addEventListener('click', function(){ window.location.href = 'registr.html?mode=register'; });

    // Toggle profile menu items based on localStorage flag set after login
    function syncAuthMenu() {
      let authed = false;
      try { authed = localStorage.getItem('authed') === '1'; } catch(e) {}
      document.querySelectorAll('.auth-only').forEach(el=>{ el.style.display = authed ? 'none' : ''; });
      document.querySelectorAll('.authed-only').forEach(el=>{ el.style.display = authed ? '' : 'none'; });
    }
    syncAuthMenu();

    const popupLogoutBtn = document.getElementById('popupLogoutBtn');
    if (popupLogoutBtn) popupLogoutBtn.addEventListener('click', function(){ try { localStorage.removeItem('authed'); } catch(e) {} syncAuthMenu(); window.location.href = 'registr.html?mode=login'; });
    const popupSettingsBtn = document.getElementById('popupSettingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const settingsClose = document.getElementById('settingsClose');
    if (popupSettingsBtn && settingsModal) popupSettingsBtn.addEventListener('click', openSettingsDialog);
    if (settingsClose && settingsModal) settingsClose.addEventListener('click', function(){ settingsModal.classList.remove('show'); });
    if (settingsModal) settingsModal.addEventListener('click', function(e){ if (e.target === settingsModal) settingsModal.classList.remove('show'); });

    function openSettingsDialog(){
      settingsModal.classList.add('show');
      const content = settingsModal.querySelector('.content');
      // Tabs already in DOM template; just wire up handlers and values
      const chatWidth = content.querySelector('#chatWidth');
      const chatWidthVal = content.querySelector('#chatWidthVal');
      const authProviderEl = content.querySelector('#authProvider');
      const tabButtons = content.querySelectorAll('.tab-btn');
      const panels = content.querySelectorAll('.tab-panel');

      tabButtons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          tabButtons.forEach(b=>b.classList.remove('active'));
          panels.forEach(p=>p.classList.remove('active'));
          btn.classList.add('active');
          const id = 'tab-' + btn.dataset.tab;
          content.querySelector('#'+id).classList.add('active');
        })
      });

      try {
        const savedW = localStorage.getItem('chatW');
        if (savedW) {
          chatWidth.value = savedW;
          document.documentElement.style.setProperty('--chat-w', savedW + 'px');
        }
      } catch(e) {}
      const updateVal=()=>{ chatWidthVal.textContent = chatWidth.value; };
      updateVal();
      chatWidth.addEventListener('input', function(){
        document.documentElement.style.setProperty('--chat-w', chatWidth.value + 'px');
        updateVal();
        try { localStorage.setItem('chatW', chatWidth.value); } catch(e) {}
      });

      // auth provider display
      let provider = 'Гость';
      try { provider = localStorage.getItem('provider') || 'Гость'; } catch(e) {}
      authProviderEl.textContent = provider;

      // Link/unlink placeholders
      const linkGoogle = content.querySelector('#linkGoogle');
      const linkGithub = content.querySelector('#linkGithub');
      const unlinkAll = content.querySelector('#unlinkAll');
      if (linkGoogle) linkGoogle.addEventListener('click', ()=>{ try{ localStorage.setItem('provider','Google'); }catch(e){} authProviderEl.textContent='Google'; alert('Связь с Google отмечена локально. Для реального линка нужен бэкенд.'); });
      if (linkGithub) linkGithub.addEventListener('click', ()=>{ try{ localStorage.setItem('provider','GitHub'); }catch(e){} authProviderEl.textContent='GitHub'; alert('Связь с GitHub отмечена локально. Для реального линка нужен бэкенд.'); });
      if (unlinkAll) unlinkAll.addEventListener('click', ()=>{ try{ localStorage.removeItem('provider'); }catch(e){} authProviderEl.textContent='Гость'; });

      // 2FA (TOTP) demo
      const enable2fa = content.querySelector('#enable2fa');
      const disable2fa = content.querySelector('#disable2fa');
      const totpSetup = content.querySelector('#totpSetup');
      const totpSecretEl = content.querySelector('#totpSecret');
      const verifyTotp = content.querySelector('#verifyTotp');
      const totpCode = content.querySelector('#totpCode');
      const totpMsg = content.querySelector('#totpMsg');

      function generateSecret(len){
        const alphabet='ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
        let s=''; for(let i=0;i<len;i++){ s+=alphabet[Math.floor(Math.random()*alphabet.length)] }
        return s;
      }
      function getStoredSecret(){ try{ return localStorage.getItem('totpSecret')||'' }catch(e){ return '' } }
      function setStoredSecret(s){ try{ localStorage.setItem('totpSecret',s) }catch(e){} }
      function clearStoredSecret(){ try{ localStorage.removeItem('totpSecret') }catch(e){} }

      function sha1(msg, key){
        // Minimal HMAC-SHA1 using SubtleCrypto where available; fallback no-op
        if (window.crypto && crypto.subtle) {
          const enc = new TextEncoder();
          return crypto.subtle.importKey('raw', enc.encode(key), {name:'HMAC', hash:'SHA-1'}, false, ['sign'])
            .then(k=>crypto.subtle.sign('HMAC', k, enc.encode(msg)))
            .then(buf=>new Uint8Array(buf));
        }
        return Promise.resolve(new Uint8Array([]));
      }
      function toBytes(num){ const b=new Uint8Array(8); for(let i=7;i>=0;i--){ b[i]=num & 0xff; num >>=8;} return b; }
      function truncate(hmac){ if(!hmac.length) return 0; const offset = hmac[hmac.length-1] & 0x0f; const p = (hmac[offset]&0x7f)<<24 | (hmac[offset+1])<<16 | (hmac[offset+2])<<8 | (hmac[offset+3]); return p % 1000000; }
      async function verify(code){
        const secret=getStoredSecret(); if(!secret) return false;
        const step = 30; const T = Math.floor(Date.now()/1000/step);
        const res = await sha1(String(T), secret);
        const token = ('000000'+truncate(res)).slice(-6);
        return token===code;
      }

      function refresh2faUI(){ const s=getStoredSecret(); totpSetup.style.display = s? 'block':'none'; if(s) totpSecretEl.textContent=s; }
      refresh2faUI();

      if (enable2fa) enable2fa.addEventListener('click', ()=>{ const s=generateSecret(16); setStoredSecret(s); refresh2faUI(); totpMsg.textContent='Секрет сгенерирован. Подтвердите одноразовый код.'; });
      if (disable2fa) disable2fa.addEventListener('click', ()=>{ clearStoredSecret(); refresh2faUI(); totpMsg.textContent='2FA выключена.'; });
      if (verifyTotp) verifyTotp.addEventListener('click', async ()=>{ const ok=await verify((totpCode.value||'').trim()); totpMsg.textContent = ok? 'Код верный. 2FA активна.':'Неверный код.'; });
    }

    // Кнопка быстрого переключения темы
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    if (themeToggleBtn) themeToggleBtn.remove();

    // If redirected after login with ?start=chat, open chat layout directly
    try {
      const params = new URLSearchParams(window.location.search);
      if (params.get('start') === 'chat') {
        screenSearch.style.display = 'none';
        screenChat.style.display = 'block';
        document.getElementById('welcome').style.display = 'none';
        document.getElementById('messagesWrap').style.display = 'grid';
        // create empty chat so история видна и можно сразу писать
      const chat = createChat('Новый диалог');
      openChat(chat.id);
        composerInput.focus();
      }
    } catch (e) {}

    // Sidebar toggle with persistence
    const sideToggle = document.getElementById('collapseBtn');
    const layoutEl = document.querySelector('.layout');
    function applySidebarState() {
      let collapsed = false;
      try { collapsed = localStorage.getItem('sidebarCollapsed') === '1'; } catch(e) {}
      layoutEl.classList.toggle('collapsed', collapsed);
    }
    applySidebarState();
    // Force collapsed sidebar on small screens for better mobile UX
    try { if (window.innerWidth <= 768) { layoutEl.classList.add('collapsed'); } } catch(e) {}
    // Offset floating buttons when sidebar is open to avoid overlap with 'Новый чат'
    function offsetFloatStack() { /* плавающие кнопки скрыли */ }
    offsetFloatStack();
    if (sideToggle) sideToggle.addEventListener('click', function(){
      const collapsed = !layoutEl.classList.contains('collapsed');
      layoutEl.classList.toggle('collapsed');
      try { localStorage.setItem('sidebarCollapsed', collapsed ? '1' : '0'); } catch(e) {}
      offsetFloatStack();
    });
    // Mini dock actions (when sidebar collapsed)
    const miniDock = document.getElementById('miniDock');
    const miniProfile = document.getElementById('miniProfile');
    const miniMenu = document.getElementById('miniMenu');
    const miniNewChat = document.getElementById('miniNewChat');
    const miniSettings = document.getElementById('miniSettings');
    const miniLogout = document.getElementById('miniLogout');
    if (miniProfile) miniProfile.addEventListener('click', function(){ miniMenu.classList.toggle('show'); });
    if (miniNewChat) miniNewChat.addEventListener('click', function(){ const chat = createChat('Новый диалог'); openChat(chat.id); });
    if (miniSettings) miniSettings.addEventListener('click', function(){ document.getElementById('settingsModal').classList.add('show'); miniMenu.classList.remove('show'); });
    if (miniLogout) miniLogout.addEventListener('click', function(){ try { localStorage.removeItem('authed'); } catch(e) {} window.location.href = 'registr.html?mode=login'; });
  </script>
</body>
</html>


